name: Create repo
on:
  push:
  pull_request:
    types: [opened, reopened, edited, closed]
jobs:
  delete-repo:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && github.event.action == 'closed'
    steps:
      - uses: octokit/request-action@v2.x
        id: create
        with:
          route: DELETE /repos/{org}/{repo}
          org: Material-Blazor
          accept: 'application/vnd.github.v3+json'
          repo: TestingTheApiIgnoreMe
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}
      - run: echo "${{ steps.create.outputs.data }}"
  create-repo:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && (github.event.action == 'opened' || github.event.action == 'reopened')
    steps:
      - uses: octokit/request-action@v2.x
        id: create
        with:
          route: POST /orgs/{org}/repos
          org: Material-Blazor
          accept: 'application/vnd.github.v3+json'
          name: TestingTheApiIgnoreMe
          description: This is an automatically generated repo. Ignore me.
          visibility: private
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}
      - run: echo "${{ steps.create.outputs.data }}"
        if: always()
  deploy-to-repo:
    needs: [ create-repo ]
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && (github.event.action == 'opened' || github.event.action == 'reopened' || github.event.action == 'edited')
    steps:
    - name: Checkout repository under $GITHUB_WORKSPACE so the job can access it 🛎️
      uses: actions/checkout@v2
    - name: Create some content
      run: |
        mkdir deployroot
        echo "Hello PR" > deployroot/Readme.md
    - name: Deploy 🚀
      uses: JamesIves/github-pages-deploy-action@4.1.0
      with:
        token: ${{secrets.GH_PAT}}
        branch: gh-pages
        folder: 'deployroot'
        repository-name: Material-Blazor/TestingTheApiIgnoreMe
  wait-for-non-404:
    needs: [ deploy-to-repo ]
    runs-on: ubuntu-latest
    steps:
    - name: Waiting...
      run: |
        i=0
        while :
        do
          curl --fail https://material-blazor.github.io/TestingTheApiIgnoreMe/?attempt=$i && break
          echo "The page https://material-blazor.github.io/TestingTheApiIgnoreMe/?attempt=$i doesn't seem available yet"
          sleep 5
          i=$((i+1))
        done


